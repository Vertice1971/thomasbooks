<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trivia Geografía e Historia – Temarios</title>
<style>
    :root{
        --bg:#0a0c10; --card:#11151c; --text:#e7edf3; --muted:#9fb0c3;
        --accent:#ffd23f; --accent2:#34c759; --danger:#ff453a; --focus:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
        margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans";
        background:linear-gradient(180deg,#0a0c10 0%, #0d1117 100%);
        color:var(--text);-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }
    .contenedor{max-width:920px;margin:0 auto;padding:24px}
    header{margin-bottom:16px}
    h1{margin:0;font-weight:800;letter-spacing:.3px}
    .sub{margin:8px 0 0 0;color:var(--muted)}
    .tarjeta{
        background:var(--card);border:1px solid #1d2530;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .fila{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    button{
        background:#1a2330;color:var(--text);border:1px solid #283346;padding:12px 16px;border-radius:12px;
        font-weight:700;cursor:pointer;transition:.15s transform ease,.15s background ease,.15s border-color ease,.15s opacity ease;
    }
    button:hover{transform:translateY(-1px);border-color:#3a4a63}
    button:active{transform:translateY(0)}
    .primario{background:var(--accent);color:#111;border-color:#b69500}
    .exito{background:var(--accent2);color:#041;border-color:#1f7a3a}
    .peligro{background:var(--danger);color:#2b0302;border-color:#c21e16}
    .fantasma{background:transparent}
    .oculto{display:none !important}

    .panel-config label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    .panel-config input[type="number"], .panel-config select{
        width:100%;padding:10px 12px;border-radius:10px;border:1px solid #283346;background:#0f1319;color:var(--text);outline:none;
    }
    .panel-config input[type="checkbox"]{transform:scale(1.2);margin-right:8px}
    .grupo{margin-bottom:14px}

    .estado{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .progreso{width:100%;height:10px;background:#121923;border-radius:999px;overflow:hidden;border:1px solid #233047}
    .barra{height:100%;width:0%;background:linear-gradient(90deg,#ffd23f,#ffb703);transition:width .3s ease}
    .contador-puntos{min-width:120px;text-align:center;padding:8px 10px;border-radius:10px;border:1px solid #283346;background:#0f1319}

    .pregunta{font-size:20px;line-height:1.35;margin:6px 0 12px 0;font-weight:700}
    .opciones{display:grid;gap:10px}
    .opcion{
        padding:12px 14px;border-radius:12px;border:1px solid #2b3649;background:#0e141b;cursor:pointer;display:flex;gap:10px;align-items:flex-start;text-align:left
    }
    .opcion:hover{border-color:#3c4f6c}
    .opcion.correcta{background:rgba(52,199,89,.12);border-color:rgba(52,199,89,.6)}
    .opcion.incorrecta{background:rgba(255,69,58,.10);border-color:rgba(255,69,58,.55)}
    .opcion .letra{
        width:28px;height:28px;display:inline-grid;place-items:center;border-radius:8px;border:1px solid #344055;background:#121826;color:var(--muted);font-weight:700;flex:0 0 auto
    }

    .pie{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    .resultado{font-size:18px;margin:0;color:var(--muted)}
    .medalla{font-weight:800;color:var(--accent)}
    .seleccionable{user-select:none}

    @media (prefers-reduced-motion:no-preference){
        .aparece{animation:aparece .25s ease both}
        @keyframes aparece{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}
    }
</style>
</head>
<body>
<div class="contenedor">
    <header>
        <h1>Oposiciones Secundaria: Geografía e Historia</h1>
        <h2>Conforme al temario vigente establecido en la Orden de 9 de septiembre de 1993</h2>
        <p class="sub" style="color: rgb(247, 227, 3);">Elige el tema y la cantidad de preguntas</p>
        <p class="sub" style="font-size: 0.85em;">tomcue@iesjuandelacierva.com</p>
    </header>

    <section id="pantalla-inicio" class="tarjeta aparece">
        <div class="fila">
            <div class="col panel-config">
                <div class="grupo">
                    <label for="tema">Temario</label>
                    <select id="tema">
                        <option value="01-La-concepcion-del-espacio-geografico-corrientes-actuales-del-pensamiento-geografico.js">1 - La concepción del espacio geográfico. Corrientes actuales del pensamiento geográfico</option>
                        <option value="02-Metodologia-del-trabajo-geografico-tecnicas-de-trabajo.js">2 - Metodología del trabajo geográfico. Técnicas de trabajo</option>
                        <option value="03-La-diversidad-del-medio-geografico-en-el-planeta-la-interaccion-de-factores-ecogeograficos.js">3 - La diversidad del medio geográfico en el planeta. La interacción de factores ecogeográficos</option>
                        <option value="04-Climas-y-zonas-bioclimaticas-el-tiempo-y-el-clima-como-condicionantes-de-las-actividades-humanas.js">4 - Climas y zonas bioclimáticas. El tiempo y el clima como condicionantes de las actividades humanas</option>
                        <option value="05-La-accion-humana-sobre-el-medio-problematica-actual.js">5 - La acción humana sobre el medio. Problemática actual</option>
                        <option value="06-La-poblacion-mundial-modelos-demograficos-y-desigualdades-espaciales.js">6 - La población mundial: modelos demográficos y desigualdades espaciales</option>
                        <option value="07-El-espacio-rural-actividades-agrarias-situacion-y-perspectivas-en-espana-y-en-el-mundo.js">7 - El espacio rural. Actividades agrarias: situación y perspectivas en España y en el mundo</option>
                        <option value="08-El-espacio-y-la-actividad-industrial-materias-primas-y-fuentes-de-energia.js">8 - El espacio y la actividad industrial. Materias primas y fuentes de energía</option>
                        <option value="09-Las-actividades-terciarias-en-las-economias-desarrolladas.js">9 - Las actividades terciarias en las economías desarrolladas</option>
                        <option value="10-El-proceso-de-urbanizacion-en-el-planeta-repercusiones-ambientales-y-socioeconomicas.js">10 - El proceso de urbanización en el planeta. Repercusiones ambientales y socioeconómicas</option>
                        <option value="11-Los-paises-de-la-comunidad-europea-aspectos-fisicos-sociales-y-economicos.js">11 - Los países de la Comunidad Europea: aspectos físicos, sociales y económicos</option>
                        <option value="12-China-sociedad-y-economia.js">12 - China: sociedad y economía</option>
                        <option value="13-Japon-y-el-area-del-pacifico-desarrollo-industrial-y-comercial.js">13 - Japón y el área del Pacífico: desarrollo industrial y comercial</option>
                        <option value="14-Africa-territorio-y-sociedades-africa-mediterranea-y-africa-subsahariana-contrastes-fisicos-socioeconomicos-y-culturales.js">14 - África: territorio y sociedades. África Mediterránea y África Subsahariana: contrastes físicos, socioeconómicos y culturales</option>
                        <option value="15-Canada-y-eeuu-aspectos-fisicos-y-humanos.js">15 - Canadá y EE.UU.: aspectos físicos y humanos</option>
                        <option value="16-Los-paises-iberoamericanos-problematica-economica-y-social.js">16 - Los países iberoamericanos: problemática económica y social</option>
                        <option value="17-La-peninsula-iberica-relieve-clima-y-vegetacion-diversidad-regional-de-la-espana-peninsular-e-insular.js">17 - La península Ibérica: relieve, clima y vegetación. Diversidad regional de la España Peninsular e Insular</option>
                        <option value="18-La-actual-ordenacion-territorial-del-estado-espanol-raices-historicas.js">18 - La actual ordenación territorial del Estado español. Raíces históricas</option>
                        <option value="19-La-poblacion-espanola-comportamiento-demografico-fenomenos-migratorios.js">19 - La población española. Comportamiento demográfico. Fenómenos migratorios</option>
                        <option value="20-El-conocimiento-historico-tiempo-historico-y-categorias-temporales-el-historiador-y-las-fuentes-explicacion-y-comprension-en-la-historia.js">20 - El conocimiento histórico. Tiempo histórico y categorías temporales. El historiador y las fuentes. Explicación y comprensión en la historia</option>
                        <option value="21-Grandes-lineas-de-investigacion-historica-en-los-siglos-xix-y-xx.js">21 - Grandes líneas de investigación histórica en los siglos XIX y XX</option>
                        <option value="22-Proceso-de-hominizacion-y-cultura-material-la-aportacion-de-la-antropologia-historica.js">22 - Proceso de hominización y cultura material. La aportación de la antropología histórica</option>
                        <option value="23-Del-neolitico-a-las-sociedades-urbanas-del-proximo-oriente-fuentes-arqueologicas.js">23 - Del neolítico a las sociedades urbanas del Próximo Oriente. Fuentes arqueológicas</option>
                        <option value="24-La-peninsula-iberica-hasta-la-dominacion-romana.js">24 - La península Ibérica hasta la dominación romana</option>
                        <option value="25-La-civilizacion-grecolatina.js">25 - La civilización grecolatina</option>
                        <option value="26-Origenes-y-desarrollo-del-feudalismo-la-economia-senorial-debate-historiografico.js">26 - Orígenes y desarrollo del feudalismo. La economía señorial. Debate historiográfico</option>
                        <option value="27-Nacimiento-y-expansion-del-islam.js">27 - Nacimiento y expansión del islam</option>
                        <option value="28-Al-andalus-politica-sociedad-y-cultura.js">28 - Al-Andalus: política, sociedad y cultura</option>
                        <option value="29-La-expansion-de-los-reinos-cristianos-en-la-peninsula-iberica.js">29 - La expansión de los reinos cristianos en la península Ibérica</option>
                        <option value="30-La-formacion-de-las-monarquias-feudales-en-europa.js">30 - La formación de las monarquías feudales en la Europa</option>
                        <option value="31-Los-reinos-peninsulares-en-los-siglos-xiv-y-xv-conflictos-sociales-diversidad-cultural.js">31 - Los reinos peninsulares en los siglos XIV y XV. Conflictos sociales. Diversidad cultural</option>
                        <option value="32-La-cultura-renacentista-los-enfrentamientos-politico-religiosos-del-siglo-xvi.js">32 - La cultura renacentista. Los enfrentamientos político-religiosos del siglo XVI</option>
                        <option value="33-La-monarquia-hispanica-bajo-los-austrias-aspectos-politicos-economicos-y-culturales.js">33 - La Monarquía hispánica bajo los Austrias: aspectos políticos, económicos y culturales</option>
                        <option value="34-Conquista-colonizacion-y-administracion-de-la-america-hispanica-en-los-siglos-xvi-al-xviii.js">34 - Conquista, colonización y administración de la América Hispánica en los siglos XVI al XVIII</option>
                        <option value="35-El-pensamiento-politico-moderno-del-humanismo-a-la-ilustracion.js">35 - El pensamiento político moderno: del Humanismo a la Ilustración</option>
                        <option value="36-Crecimiento-economico-estructuras-y-mentalidades-sociales-en-europa-del-siglo-xviii-las-transformaciones-politicas-en-espana-del-siglo-xviii.js">36 - Crecimiento económico, estructuras y mentalidades sociales en la Europa del siglo XVIII. Las transformaciones políticas en la España del S. XVIII</option>
                        <option value="37-El-debate-historiografico-sobre-la-revolucion-francesa-el-origen-de-los-estados-modernos.js">37 - El debate historiográfico sobre la Revolución francesa. occidental. El origen de los estados modernos</option>
                        <option value="38-Revolucion-industrial-e-industrializacion.js">38 - Revolución industrial e industrialización</option>
                        <option value="39-La-construccion-del-estado-liberal-y-primeros-intentos-democratizadores-en-espana-del-siglo-xix.js">39 - La construcción del estado liberal y primeros intentos democratizadores en la España del siglo XIX</option>
                        <option value="40-Transformaciones-agrarias-y-proceso-de-industrializacion-en-espana-del-siglo-xix.js">40 - Transformaciones agrarias y proceso de industrialización en la España del siglo XIX</option>
                        <option value="41-Nacionalismo-y-liberalismo-en-europa-del-siglo-xix.js">41 - Nacionalismo y liberalismo en la Europa del S. XIX</option>
                        <option value="42-Imperialismo-y-expansion-colonial-los-conflictos-internacionales-antes-de-1914.js">42 - Imperialismo y expansión colonial. Los conflictos internacionales antes de 1914</option>
                        <option value="43-Pensamiento-politico-y-economico-en-el-siglo-xix.js">43 - Pensamiento político y económico en el siglo XIX</option>
                        <option value="44-El-proceso-de-independencia-de-america-latina.js">44 - El proceso de independencia de América Latina</option>
                        <option value="45-Las-transformaciones-del-extremo-oriente-desde-1886-a-1949.js">45 - Las transformaciones del Extremo Oriente desde 1886 a 1949</option>
                        <option value="46-Los-estados-balcanicos-en-el-siglo-xx.js">46 - Los Estados balcánicos en el siglo XX</option>
                        <option value="47-La-primera-guerra-mundial-y-las-relaciones-internacionales-en-el-periodo-de-entreguerras-la-crisis-de-1929.js">47 - La primera guerra mundial y las relaciones internacionales en el período de entreguerras. La crisis de 1929</option>
                        <option value="48-Fascismo-y-neofascismo-caracteres-y-circunstancias-en-que-se-desarrollan.js">48 - Fascismo y neofascismo: caracteres y circunstancias en que se desarrollan</option>
                        <option value="49-Espana-la-ii-republica-y-la-guerra-civil.js">49 - España: la II República y la guerra civil</option>
                        <option value="50-Las-revoluciones-rusas-creacion-desarrollo-y-crisis-de-la-urss-repercusiones-internacionales.js">50 - Las revoluciones rusas: creación, desarrollo y crisis de la URSS. Repercusiones internacionales</option>
                        <option value="51-Repercusiones-de-la-segunda-guerra-mundial-las-relaciones-internacionales-despues-de-1945-la-politica-de-bloques-la-onu.js">51 - Repercusiones de la segunda guerra mundial. Las relaciones internacionales después de 1945. La política de bloques. La ONU</option>
                        <option value="52-La-descolonizacion-de-asia-y-africa-los-problemas-del-tercer-mundo.js">52 - La descolonización de Asia y África: los problemas del Tercer Mundo</option>
                        <option value="53-La-dictadura-franquista-regimen-politico-evolucion-social-y-economica.js">53 - La dictadura franquista: régimen político, evolución social y económica</option>
                        <option value="54-La-construccion-de-la-comunidad-europea.js">54 - La construcción de la Comunidad Europea</option>
                        <option value="55-Teoria-y-funcion-del-arte-analisis-e-interpretacion-de-la-obra-de-arte.js">55 - Teoría y función del arte. Análisis e interpretación de la obra de arte</option>
                        <option value="56-El-arte-clasico-grecia-y-roma.js">56 - El arte clásico: Grecia y Roma</option>
                        <option value="57-El-arte-romanico.js">57 - El arte románico</option>
                        <option value="58-El-arte-islamico.js">58 - El arte islámico</option>
                        <option value="59-El-arte-gotico.js">59 - El arte gótico</option>
                        <option value="60-El-arte-del-renacimiento-italiano-y-su-influencia.js">60 - El arte del Renacimiento italiano y su influencia</option>
                        <option value="61-El-arte-barroco.js">61 - El arte barroco</option>
                        <option value="62-Velazquez-y-goya-en-su-contexto-artistico.js">62 - Velázquez y Goya en su contexto artístico</option>
                        <option value="63-Las-artes-plasticas-del-impresionismo-a-la-abstraccion.js">63 - Las artes plásticas del impresionismo a la abstracción</option>
                        <option value="64-La-arquitectura-en-los-siglos-xix-y-xx-el-modernismo.js">64 - La arquitectura en los siglos XIX y XX. El Modernismo</option>
                        <option value="65-Picasso-dali-y-miro-en-su-contexto-artistico.js">65 - Picasso, Dalí y Miró en su contexto artístico</option>
                        <option value="66-Interdependencias-y-desequilibrios-en-el-mundo-actual-desarrollo-y-subdesarrollo-desarrollo-sostenible.js">66 - Interdependencias y desequilibrios en el mundo actual. Desarrollo y subdesarrollo. Desarrollo sostenible</option>
                        <option value="67-Analisis-de-la-constitucion-espanola-de-1978.js">67 - Análisis de la Constitución Española de 1978</option>
                        <option value="68-Organizacion-economica-y-mundo-del-trabajo-la-inflacion-el-desempleo-y-la-politica-monetaria.js">68 - Organización económica y mundo del trabajo. La inflación, el desempleo y la política monetaria</option>
                        <option value="69-Regimenes-politicos-y-sus-conflictos-internos-en-el-mundo-actual-principales-focos-de-tension-en-las-relaciones-internacionales.js">69 - Regímenes políticos y sus conflictos internos en el mundo actual. Principales focos de tensión en las relaciones internacionales</option>
                        <option value="70-Medios-de-comunicacion-y-sociedad-de-masas.js">70 - Medios de comunicación y sociedad de masas</option>
                        <option value="71-Revolucion-cientifico-tecnica-en-el-siglo-xx-implicaciones-en-la-sociedad.js">71 - Revolución científico-técnica en el siglo XX. Implicaciones en la sociedad</option>
                        <option value="72-Cambio-social-y-movimientos-alternativos-feminismo-pacifismo-y-ecologismo.js">72 - Cambio social y movimientos alternativos. Feminismo, pacifismo y ecologismo</option>
                    </select>
                </div>
                <div class="grupo">
                    <label for="cantidad">Número de preguntas</label>
                    <input id="cantidad" type="number" min="5" max="40" value="12" />
                </div>
            </div>
            <div class="col">
                <p style="color:var(--muted);margin-top:0">Elige "Comenzar" para hacer el test o "Modo estudio" para repasar todas las respuestas.</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                    <button id="btn-comenzar" class="primario">Comenzar</button>
                    <button id="btn-aprender" title="Muestra todas las preguntas del temario en modo estudio">Modo estudio</button>
                </div>
            </div>
        </div>
    </section>

    <section id="pantalla-juego" class="tarjeta oculto">
        <div class="estado">
            <div class="contador-puntos"><strong id="xIndex">1</strong>/<span id="xTotal">12</span> · Puntos: <strong id="xPuntos">0</strong></div>
            <div class="progreso" aria-hidden="true"><div id="barra" class="barra" style="width:0%"></div></div>
        </div>

        <div id="enunciado" class="pregunta"></div>
        <div id="opciones" class="opciones"></div>

        <div class="pie">
            <div>
                <button id="btn-anterior" class="fantasma">Anterior</button>
                <button id="btn-saltar">Saltar</button>
            </div>
            <div>
                <button id="btn-comprobar" class="primario">Comprobar</button>
                <button id="btn-siguiente" class="exito oculto">Siguiente</button>
                <button id="btn-terminar" class="peligro oculto">Terminar</button>
            </div>
        </div>
    </section>

    <section id="pantalla-final" class="tarjeta oculto">
        <p class="resultado" id="resumen"></p>
        <div class="fila" style="margin-top:12px">
            <button id="btn-repetir" class="primario">Repetir configuración</button>
            <button id="btn-inicio">Volver al inicio</button>
            <button id="btn-estudio">Repasar preguntas</button>
        </div>
    </section>

    <section id="pantalla-estudio" class="tarjeta oculto">
        <div id="lista-estudio"></div>
        <div class="pie"><button id="btn-salir-estudio">Salir</button></div>
    </section>
</div>

<script>
/* ===== Utilidades ===== */
function barajar(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

/* ===== Carga de temarios (PREGUNTAS con enunciado/correcta/incorrectas) ===== */
let BANCO = [];

function cargarTemario(nombreArchivo){
    return new Promise((resolve, reject)=>{
        delete window.PREGUNTAS;
        const prev = document.getElementById("temario-script");
        if(prev) prev.remove();

        const s = document.createElement("script");
        s.id = "temario-script";
        s.async = true;
        s.src = `temarios/${nombreArchivo}?t=${Date.now()}`;
        s.onload = ()=>{
            if(typeof window.PREGUNTAS === "undefined" || !Array.isArray(window.PREGUNTAS)){
                reject(new Error("El temario no define PREGUNTAS válidas."));
                return;
            }
            BANCO = convertirPreguntas(window.PREGUNTAS);
            resolve(BANCO);
        };
        s.onerror = ()=>reject(new Error("No se pudo cargar el temario."));
        document.body.appendChild(s);
    });
}

function convertirPreguntas(arr){
    return arr.map(p=>{
        const opciones = [p.correcta, ...(p.incorrectas||[])];
        const idxs = opciones.map((_,i)=>i);
        barajar(idxs);
        const opsBarajadas = idxs.map(i=>opciones[i]);
        const indiceCorrecta = idxs.indexOf(0); // 0 porque 'correcta' estaba en primera posición
        return {
            pregunta: p.enunciado,
            opciones: opsBarajadas,
            correcta: indiceCorrecta,
            explicacion: ""        // sin explicaciones en juego (opción eliminada)
        };
    });
}

/* ===== Estado/UI ===== */
const ui = {
    inicio:      document.getElementById("pantalla-inicio"),
    juego:       document.getElementById("pantalla-juego"),
    final:       document.getElementById("pantalla-final"),
    estudio:     document.getElementById("pantalla-estudio"),
    tema:        document.getElementById("tema"),
    cantidad:    document.getElementById("cantidad"),
    enunciado:   document.getElementById("enunciado"),
    opciones:    document.getElementById("opciones"),
    idx:         document.getElementById("xIndex"),
    total:       document.getElementById("xTotal"),
    puntos:      document.getElementById("xPuntos"),
    barra:       document.getElementById("barra"),
    resumen:     document.getElementById("resumen"),
    listaEstudio:document.getElementById("lista-estudio"),
    btns:{
        comenzar: document.getElementById("btn-comenzar"),
        aprender: document.getElementById("btn-aprender"),
        anterior: document.getElementById("btn-anterior"),
        saltar:   document.getElementById("btn-saltar"),
        comprobar:document.getElementById("btn-comprobar"),
        siguiente:document.getElementById("btn-siguiente"),
        terminar: document.getElementById("btn-terminar"),
        repetir:  document.getElementById("btn-repetir"),
        inicio:   document.getElementById("btn-inicio"),
        estudio:  document.getElementById("btn-estudio"),
        salirEst: document.getElementById("btn-salir-estudio")
    }
};

let estado = {
    preguntas: [], orden: [], actual: 0, puntos: 0, seleccion: null
};

/* ===== Navegación ===== */
function mostrar(section){
    for(const s of [ui.inicio, ui.juego, ui.final, ui.estudio]) s.classList.add("oculto");
    section.classList.remove("oculto");
    section.classList.add("aparece");
}

/* ===== Preparación desde BANCO (sin dificultad, sin temporizador, sin opción explicaciones) ===== */
function prepararJuego(opts){
    const conjunto = barajar([...BANCO]); // Siempre se barajan las preguntas
    const n = Math.max(5, Math.min(opts.cantidad, conjunto.length));
    const seleccion = conjunto.slice(0, n).map(clonarYBarajarOpciones);

    estado.preguntas = seleccion;
    estado.orden = [...Array(estado.preguntas.length).keys()];
    estado.actual = 0; estado.puntos = 0; estado.seleccion = null;

    ui.total.textContent = String(estado.preguntas.length);
    ui.puntos.textContent = "0";
    ui.barra.style.width = "0%";
    pintarPregunta();
    mostrar(ui.juego);
}

function clonarYBarajarOpciones(qo){
    const copia = JSON.parse(JSON.stringify(qo));
    const idxs = copia.opciones.map((_,i)=>i);
    barajar(idxs);
    const ops = idxs.map(i=>copia.opciones[i]);
    const corr = idxs.indexOf(copia.correcta);
    copia.opciones = ops; copia.correcta = corr;
    return copia;
}

/* ===== Pintado ===== */
function pintarPregunta(){
    const i = estado.actual;
    const q = estado.preguntas[i];
    ui.idx.textContent = String(i+1);
    ui.enunciado.textContent = q.pregunta;
    ui.opciones.innerHTML = "";
    ui.btns.siguiente.classList.add("oculto"); ui.btns.terminar.classList.add("oculto");
    ui.btns.comprobar.classList.remove("oculto");

    const letras = "ABCD".split("");
    q.opciones.forEach((texto, idx)=>{
        const btn = document.createElement("button");
        btn.className = "opcion";
        btn.setAttribute("data-idx", idx);
        btn.innerHTML = `<span class="letra">${letras[idx]||"?"}</span><span>${texto}</span>`;
        btn.addEventListener("click", ()=>seleccionar(idx));
        ui.opciones.appendChild(btn);
    });

    actualizarProgreso(); estado.seleccion = null;
}

function seleccionar(idx){
    if(ui.btns.comprobar.classList.contains("oculto")) return;
    estado.seleccion = idx;
    [...ui.opciones.children].forEach(el=>el.style.outline="none");
    const el = ui.opciones.querySelector(`[data-idx="${idx}"]`);
    el.style.outline = `2px solid var(--focus)`;
    el.scrollIntoView({block:"nearest", behavior:"smooth"});
}

function actualizarProgreso(){
    const pct = (estado.actual/estado.preguntas.length)*100;
    ui.barra.style.width = `${pct}%`;
}

/* ===== Comprobación/flujo ===== */
function comprobar(){
    const q = estado.preguntas[estado.actual];
    const sel = estado.seleccion;
    const acierto = sel === q.correcta;

    [...ui.opciones.children].forEach((btn, idx)=>{
        if(idx===q.correcta) btn.classList.add("correcta");
        if(sel!==null && idx===sel && sel!==q.correcta) btn.classList.add("incorrecta");
        btn.style.cursor="default";
    });

    if(acierto){ estado.puntos++; ui.puntos.textContent = String(estado.puntos); }

    ui.btns.comprobar.classList.add("oculto");
    const ultima = estado.actual === estado.preguntas.length - 1;
    if(ultima){ ui.btns.terminar.classList.remove("oculto"); }
    else{ ui.btns.siguiente.classList.remove("oculto"); }
}

function siguiente(){
    estado.actual++;
    pintarPregunta();
}
function anterior(){
    if(estado.actual===0) return;
    estado.actual--;
    pintarPregunta();
}
function saltar(){
    estado.seleccion = null;
    comprobar();
}

/* ===== Final ===== */
function terminar(){
    mostrar(ui.final);
    const n = estado.preguntas.length, p = estado.puntos, r = p/n;
    const med = r>=0.85 ? "Oro" : r>=0.65 ? "Plata" : r>=0.45 ? "Bronce" : "Finalista";
    ui.resumen.innerHTML = `Resultado: <span class="medalla">${med}</span>. Aciertos ${p}/${n}.`;
}

/* ===== Estudio ===== */
function entrarEstudio(pregs = BANCO){
    ui.listaEstudio.innerHTML = "";
    const frag = document.createDocumentFragment();
    const letras = "ABCD".split("");
    pregs.forEach((q,i)=>{
        const card = document.createElement("div");
        card.className = "tarjeta"; card.style.marginBottom = "12px";
        const h = document.createElement("div"); h.className = "pregunta"; h.textContent = `${i+1}. ${q.pregunta}`;
        const lista = document.createElement("div"); lista.className = "opciones";
        q.opciones.forEach((op,idx)=>{
            const p = document.createElement("div");
            p.className = "opcion " + (idx===q.correcta?"correcta":"");
            p.innerHTML = `<span class="letra">${letras[idx]}</span><span>${op}</span>`;
            lista.appendChild(p);
        });
        const ex = document.createElement("div"); ex.className = "explicacion"; ex.textContent = q.explicacion || "";
        card.append(h, lista, ex); frag.appendChild(card);
    });
    ui.listaEstudio.appendChild(frag);
    mostrar(ui.estudio);
}

/* ===== Eventos ===== */
async function iniciarDesdeTemario(archivo, opts){
    await cargarTemario(archivo);
    prepararJuego(opts);
}

ui.btns.comenzar.addEventListener("click", async ()=>{
    await iniciarDesdeTemario(ui.tema.value, {
        cantidad: Number(ui.cantidad.value || 12)
    });
});

ui.btns.aprender.addEventListener("click", async ()=>{
    await cargarTemario(ui.tema.value);
    entrarEstudio(barajar([...BANCO]));
});

ui.btns.comprobar.addEventListener("click", comprobar);
ui.btns.siguiente.addEventListener("click", siguiente);
ui.btns.anterior.addEventListener("click", anterior);
ui.btns.saltar.addEventListener("click", saltar);
ui.btns.terminar.addEventListener("click", terminar);

ui.btns.repetir.addEventListener("click", async ()=>{
    await iniciarDesdeTemario(ui.tema.value, {
        cantidad: estado.preguntas.length
    });
});
ui.btns.inicio.addEventListener("click", ()=>mostrar(ui.inicio));
ui.btns.estudio.addEventListener("click", ()=>entrarEstudio(estado.preguntas));
ui.btns.salirEst.addEventListener("click", ()=>mostrar(ui.final));

document.addEventListener("keydown", (e)=>{
    if(ui.juego.classList.contains("oculto")) return;
    if(e.key==="Enter") {
        if(!ui.btns.comprobar.classList.contains("oculto")) comprobar();
        else if(!ui.btns.siguiente.classList.contains("oculto")) siguiente();
    }
    if(e.key==="ArrowRight" && !ui.btns.siguiente.classList.contains("oculto")) siguiente();
    if(e.key==="ArrowLeft") anterior();
});

/* Inicio */
mostrar(ui.inicio);
</script>
</body>
</html>
