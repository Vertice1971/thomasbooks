<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Física y Química – Temarios</title>
<style>
    :root{
        --bg:#0a0c10; --card:#11151c; --text:#e7edf3; --muted:#9fb0c3;
        --accent:#ffd23f; --accent2:#34c759; --danger:#ff453a; --focus:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
        margin:0;
        font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Noto Sans Math";
        background:linear-gradient(180deg,#0a0c10 0%, #0d1117 100%);
        color:var(--text);-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }

    /* Portada previa */
    body.bloqueado{overflow:hidden}
    #cover{
        position:fixed;inset:0;
        background:#000;
        display:flex;align-items:center;justify-content:center;
        z-index:10000;
        opacity:1;visibility:visible;
        transition:opacity .6s ease, visibility 0s linear .6s;
        pointer-events:auto;
    }
    #cover.oculta{opacity:0;visibility:hidden}
    #cover img{
        max-width:100%;max-height:100%;
        border-radius:12px;
        box-shadow:0 20px 40px rgba(0,0,0,.6);
        filter:brightness(1.05) contrast(1.05);
        user-select:none;
    }

    .contenedor{max-width:920px;margin:0 auto;padding:24px}
    header{margin-bottom:16px}
    h1{margin:0;font-weight:800;letter-spacing:.3px}
    .sub{margin:8px 0 0 0;color:var(--muted)}
    .tarjeta{
        background:var(--card);border:1px solid #1d2530;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .fila{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 280px}
    button{
        background:#1a2330;color:var(--text);border:1px solid #283346;padding:12px 16px;border-radius:12px;
        font-weight:700;cursor:pointer;transition:.15s transform ease,.15s background ease,.15s border-color ease,.15s opacity ease;
    }
    button:hover{transform:translateY(-1px);border-color:#3a4a63}
    button:active{transform:translateY(0)}
    .primario{background:var(--accent);color:#111;border-color:#b69500}
    .exito{background:var(--accent2);color:#041;border-color:#1f7a3a}
    .peligro{background:var(--danger);color:#2b0302;border-color:#c21e16}
    .fantasma{background:transparent}
    .oculto{display:none !important}

    .panel-config label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    .panel-config input[type="number"], .panel-config select{
        width:100%;padding:10px 12px;border-radius:10px;border:1px solid #283346;background:#0f1319;color:var(--text);outline:none;
    }
    .panel-config input[type="checkbox"]{transform:scale(1.2);margin-right:8px}
    .grupo{margin-bottom:14px}

    .estado{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    .progreso{width:100%;height:10px;background:#121923;border-radius:999px;overflow:hidden;border:1px solid #233047}
    .barra{height:100%;width:0%;background:linear-gradient(90deg,#ffd23f,#ffb703);transition:width .3s ease}
    .contador-puntos{min-width:120px;text-align:center;padding:8px 10px;border-radius:10px;border:1px solid #283346;background:#0f1319}

    .pregunta{font-size:20px;line-height:1.35;margin:6px 0 12px 0;font-weight:700}
    .opciones{display:grid;gap:10px}
    .opcion{
        padding:12px 14px;border-radius:12px;border:1px solid #2b3649;background:#0e141b;cursor:pointer;display:flex;gap:10px;align-items:flex-start;text-align:left
    }
    .opcion:hover{border-color:#3c4f6c}
    .opcion.correcta{background:rgba(52,199,89,.12);border-color:rgba(52,199,89,.6)}
    .opcion.incorrecta{background:rgba(255,69,58,.10);border-color:rgba(255,69,58,.55)}
    .opcion .letra{
        width:28px;height:28px;display:inline-grid;place-items:center;border-radius:8px;border:1px solid #344055;background:#121826;color:var(--muted);font-weight:700;flex:0 0 auto
    }

    .pie{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    .resultado{font-size:18px;margin:0;color:var(--muted)}
    .medalla{font-weight:800;color:var(--accent)}
    .seleccionable{user-select:none}

    .enlace-contenedor{margin-top:18px}
    .enlace-constante{
        color:var(--accent);
        text-decoration:underline !important;
        text-underline-offset:3px;
        font-weight:700;
    }
    .enlace-constante:hover,
    .enlace-constante:focus{filter:brightness(1.05)}

    @media (prefers-reduced-motion:no-preference){
        .aparece{animation:aparece .25s ease both}
        @keyframes aparece{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}
    }
</style>
</head>
<body class="bloqueado">

<!-- Portada previa -->
<div id="cover" aria-hidden="true">
  <img src="Portada.png" alt="">
</div>

<div class="contenedor">
    <header>
        <h1>Oposiciones Secundaria: Física y Química</h1>
        <h2>Conforme al temario vigente establecido en la Orden de 9 de septiembre de 1993 (BOE 21 septiembre)</h2>
        <p id="cabecera-estado" class="sub" style="color: rgb(247, 227, 3);">Elige el tema y la cantidad de preguntas</p>
        <p class="sub" style="font-size: 0.85em;">tomcue@iesjuandelacierva.com</p>
    </header>

<section id="pantalla-inicio" class="tarjeta aparece">
    <div class="fila">
        <div class="col panel-config">
            <div class="grupo">
                <label for="tema">Temario</label>
                <select id="tema">
                    <option value="01-principales-concepciones-de-la-ciencia-las-revoluciones-cientificas-la-ciencia-como-proceso-en-construccion-ejemplos-en-fisica-o-quimica.js">1 - Principales concepciones de la ciencia. Revoluciones científicas. La ciencia como proceso en construcción. Ejemplos en Física o Química</option>
                    <option value="02-momentos-claves-en-el-desarrollo-de-la-fisica-y-la-quimica-principales-cientificos-y-problemas-de-investigacion-actual.js">2 - Momentos claves en el desarrollo de la Física y la Química. Científicos implicados. Problemas de investigación actuales</option>
                    <option value="03-magnitudes-fisicas-y-quimicas-sistema-internacional-de-unidades-medida-e-incertidumbre-experimental.js">3 - Magnitudes físicas y químicas. SI de unidades. Medida e incertidumbre experimental</option>
                    <option value="04-cinematica-elementos-para-la-descripcion-del-movimiento-y-metodos-experimentales.js">4 - Cinemática. Descripción del movimiento y métodos experimentales</option>
                    <option value="05-evolucion-historica-de-la-relacion-fuerza-movimiento-leyes-de-newton-y-conservacion-del-momento-lineal.js">5 - Fuerza y movimiento en la historia. Leyes de Newton y conservación del momento lineal</option>
                    <option value="06-movimiento-de-rotacion-de-una-particula-cinematica-y-dinamica-conservacion-del-momento-angular.js">6 - Movimiento de rotación de una partícula. Cinemática, dinámica y conservación del momento angular</option>
                    <option value="07-dinamica-de-un-sistema-de-particulas-conservacion-del-momento-y-de-la-energia.js">7 - Dinámica de sistemas de partículas. Conservación del momento y de la energía</option>
                    <option value="08-la-posicion-de-la-tierra-en-el-universo-sistemas-geocentrico-y-heliocentrico-teoria-de-la-gravitacion-universal.js">8 - La posición de la Tierra en el universo. Sistemas geocéntrico y heliocéntrico. Gravitación universal</option>
                    <option value="09-estatica-de-los-cuerpos-rigidos-condiciones-de-equilibrio-maquinas-e-influencia-social.js">9 - Estática de cuerpos rígidos. Condiciones de equilibrio. Máquinas e influencia social</option>
                    <option value="10-estatica-de-fluidos-presion-atmosferica-y-estudio-experimental-de-la-presion.js">10 - Estática de fluidos. Presión atmosférica. El vacío y métodos experimentales</option>
                    <option value="11-dinamica-de-fluidos-ecuacion-de-continuidad-y-de-bernoulli-regimenes-laminar-y-turbulento-aplicaciones.js">11 - Dinámica de fluidos. Continuidad y Bernoulli. Régimen laminar y turbulento. Aplicaciones</option>
                    <option value="12-gases-ideales-y-reales-teoria-cinetica-y-cambios-de-estado.js">12 - Gases ideales. Teoría cinética. Gases reales y cambios de estado</option>
                    <option value="13-fisica-de-la-atmosfera-fenomenos-atmosfericos-y-contaminacion-medidas-de-proteccion.js">13 - Física de la atmósfera. Fenómenos, balance energético y contaminación. Medidas de protección</option>
                    <option value="14-la-energia-y-su-transferencia-principio-de-conservacion-y-repercusiones-medioambientales.js">14 - La energía y su transferencia. Conservación y repercusiones medioambientales. Energías alternativas</option>
                    <option value="15-energia-interna-calor-y-temperatura-desarrollo-historico-y-propagacion-del-calor.js">15 - Energía interna, calor y temperatura. Desarrollo histórico. Propagación del calor y efectos</option>
                    <option value="16-calor-y-trabajo-en-los-procesos-termodinamicos-primera-ley-y-maquinas-termicas.js">16 - Calor y trabajo en procesos termodinámicos. Primera ley. Máquinas térmicas y rendimiento</option>
                    <option value="17-entropia-y-segundo-principio-de-la-termodinamica-orden-desorden-y-espontaneidad.js">17 - Entropía. Segundo principio. Orden/desorden y espontaneidad de las reacciones</option>
                    <option value="18-ondas-en-medios-elasticos-y-el-sonido-principio-de-superposicion-y-contaminacion-acustica.js">18 - Ondas en medios elásticos. Energía y fenómenos. Sonido y contaminación acústica</option>
                    <option value="19-naturaleza-electrica-de-la-materia-electrostatica-y-energia-de-interaccion.js">19 - Naturaleza eléctrica de la materia. Electrostática y energía de interacción</option>
                    <option value="20-corriente-electrica-circuitos-de-corriente-continua-y-ley-de-ohm.js">20 - Corriente eléctrica. Circuitos de continua. Conservación de la energía y ley de Ohm</option>
                    <option value="21-campo-magnetico-generacion-y-efectos-sobre-cargas-en-movimiento-aplicaciones.js">21 - Campo magnético. Generación y efectos sobre cargas en movimiento. Aplicaciones</option>
                    <option value="22-campos-electricos-y-magneticos-dependientes-del-tiempo-leyes-de-maxwell-e-induccion-electromagnetica.js">22 - Campos dependientes del tiempo. Leyes de Maxwell. Inducción electromagnética</option>
                    <option value="23-generacion-de-corrientes-alternas-generadores-motores-y-transformadores.js">23 - Generación de corrientes alternas. Generadores, motores y transformadores</option>
                    <option value="24-elementos-de-circuitos-electricos-resistencias-bobinas-y-condensadores-en-corriente-continua-y-alterna.js">24 - Elementos de circuitos: resistencias, bobinas y condensadores en CC y CA</option>
                    <option value="25-ondas-electromagneticas-origen-propiedades-y-aplicaciones-espectros-y-medidas-de-proteccion.js">25 - Ondas electromagnéticas. Origen, propiedades, espectros y aplicaciones. Protección</option>
                    <option value="26-optica-geometrica-principio-de-fermat-formacion-de-imagenes-y-ojo-humano.js">26 - Óptica geométrica. Principio de Fermat. Imágenes en espejos y lentes. El ojo</option>
                    <option value="27-optica-fisica-propiedades-de-las-ondas-luminosas-y-teoria-del-color.js">27 - Óptica física. Propiedades ondulatorias de la luz. Teoría física del color</option>
                    <option value="28-desarrollo-historico-de-la-unificacion-de-la-electricidad-el-magnetismo-y-la-optica.js">28 - Unificación histórica de electricidad, magnetismo y óptica</option>
                    <option value="29-limitaciones-de-la-fisica-clasica-mecanica-relativista-y-postulados-de-la-relatividad-especial.js">29 - Limitaciones de la física clásica. Mecánica relativista y relatividad especial</option>
                    <option value="30-teoria-cuantica-origen-problemas-precursores-y-fenomenos-que-la-corrobora.js">30 - Teoría cuántica. Problemas precursores y fenómenos que la corroboran</option>
                    <option value="31-dualidad-onda-corpusculo-interaccion-radiacion-materia-y-relaciones-de-incertidumbre.js">31 - Naturaleza de la luz. Dualidad onda-corpúsculo. Radiación-materia e incertidumbre</option>
                    <option value="32-sistemas-materiales-mezclas-sustancias-y-procedimientos-de-separacion-lenguaje-quimico.js">32 - Sistemas materiales. Mezclas, sustancias y separaciones. Lenguaje químico (IUPAC)</option>
                    <option value="33-teoria-atomica-de-dalton-principio-de-conservacion-de-la-masa-y-leyes-ponderales.js">33 - Teoría atómica de Dalton. Conservación de la masa y leyes ponderales</option>
                    <option value="34-modelos-atomicos-evolucion-historica-y-justificacion.js">34 - Modelos atómicos: evolución histórica y justificación</option>
                    <option value="35-el-nucleo-atomico-modelos-energia-de-enlace-y-radiacion-aplicaciones-y-seguridad.js">35 - Núcleo atómico: modelos, energía de enlace y radiactividad. Aplicaciones y seguridad</option>
                    <option value="36-fuerzas-fundamentales-de-la-naturaleza-gravitatoria-electromagnetica-fuerte-y-debil-teorias-de-unificacion.js">36 - Fuerzas fundamentales: gravitatoria, electromagnética, fuerte y débil. Unificación</option>
                    <option value="37-energia-nuclear-fision-y-fusion-utilizacion-y-residuos-nucleares.js">37 - Energía nuclear. Fisión y fusión. Utilización y residuos</option>
                    <option value="38-particulas-elementales-estado-actual-del-estudio-y-teorias-sobre-el-universo.js">38 - Partículas elementales. Estado actual. Del microcosmos al universo</option>
                    <option value="39-sistema-solar-astrofisica-y-evolucion-estelar-estructura-del-universo.js">39 - Sistema solar. Observación y medida en astrofísica. Evolución estelar y universo</option>
                    <option value="40-clasificacion-de-los-elementos-quimicos-periodicidad-y-configuracion-electronica.js">40 - Clasificación periódica. Periodicidad y configuración electrónica</option>
                    <option value="41-el-enlace-quimico-aspectos-energeticos-y-clasificacion-segun-electronegatividad.js">41 - Enlace químico. Aspectos energéticos y clasificación por electronegatividad</option>
                    <option value="42-enlace-covalente-orbitales-moleculares-diagramas-de-energia-y-geometria-molecular.js">42 - Enlace covalente. Orbitales moleculares, energía y geometría</option>
                    <option value="43-fuerzas-intermoleculares-y-sus-efectos-sobre-las-propiedades-de-las-sustancias.js">43 - Fuerzas intermoleculares. Sólidos moleculares y anomalías del agua</option>
                    <option value="44-sustancias-ionicas-formacion-de-cristales-y-compuestos-ionicos.js">44 - Sustancias iónicas. Energía y formación de cristales. Reconocimiento</option>
                    <option value="45-teoria-de-bandas-conductores-semiconductores-y-superconductores.js">45 - Teoría de bandas. Conductores, semiconductores y superconductores</option>
                    <option value="46-metales-obtencion-propiedades-aleaciones-e-interes-economico.js">46 - Metales: grupos, obtención, propiedades y aleaciones. Interés económico</option>
                    <option value="47-elementos-no-metalicos-obtencion-propiedades-y-compuestos-principales.js">47 - Elementos no metálicos: obtención, propiedades y compuestos</option>
                    <option value="48-elementos-de-transicion-compuestos-de-coordinacion-y-teorias-explicativas.js">48 - Elementos de transición. Compuestos de coordinación y teorías</option>
                    <option value="49-disoluciones-leyes-de-disoluciones-propiedades-coligativas-y-electrolitos.js">49 - Disoluciones. Leyes, propiedades coligativas y electrolitos</option>
                    <option value="50-cinetica-quimica-teorias-de-colisiones-y-del-estado-de-transicion-metodos-de-determinacion.js">50 - Cinética química. Teoría de colisiones y estado de transición. Métodos</option>
                    <option value="51-catalisis-industrial-y-biologica-enzimas-y-energia-de-activacion.js">51 - Catálisis: características y efecto sobre la energía de activación. Enzimas</option>
                    <option value="52-energia-y-transformaciones-quimicas-ecuaciones-termoquimicas-y-calores-de-reaccion.js">52 - Energía y transformaciones químicas. Termoquímica y calores de reacción</option>
                    <option value="53-entropia-y-energia-libre-de-gibbs-espontaneidad-y-equilibrio-quimico.js">53 - Entropía y energía libre de Gibbs. Espontaneidad y equilibrio</option>
                    <option value="54-equilibrio-quimico-constante-y-modificaciones-externas-equilibrios-heterogeneos.js">54 - Equilibrio químico. Constante y efectos externos. Equilibrios heterogéneos</option>
                    <option value="55-acidos-y-bases-teorias-ph-indicadores-curvas-de-valoracion-y-sistemas-amortiguadores.js">55 - Ácidos y bases. Teorías, pH, indicadores, valoraciones y tampones</option>
                    <option value="56-acidos-inorganicos-industriales-obtencion-propiedades-aplicaciones-y-seguridad.js">56 - Ácidos inorgánicos de interés industrial: obtención, propiedades y seguridad</option>
                    <option value="57-reacciones-redox-procesos-industriales-pilas-corrosion-y-metalurgia.js">57 - Oxidación-reducción. Pilas, electrólisis, corrosión y metalurgia</option>
                    <option value="58-procesos-quimicos-en-el-agua-y-el-aire-contaminacion-y-depuracion.js">58 - Procesos químicos en agua y aire. Contaminación y depuración</option>
                    <option value="59-quimica-del-carbono-estructura-enlaces-y-nomenclatura-isomeria-y-actividad-optica.js">59 - Química del carbono. Enlaces, nomenclatura, isomería y actividad óptica</option>
                    <option value="60-tipos-y-mecanismos-de-reacciones-organicas-ejemplos-caracteristicos.js">60 - Reacciones orgánicas: tipos y mecanismos. Casos característicos</option>
                    <option value="61-metodos-de-identificacion-de-compuestos-organicos-analisis-estructural-y-espectrografico.js">61 - Identificación de compuestos orgánicos. Análisis cuali-cuantitativo y espectros</option>
                    <option value="62-hidrocarburos-nomenclatura-obtencion-propiedades-e-identificacion.js">62 - Hidrocarburos. Nomenclatura, obtención, propiedades e identificación</option>
                    <option value="63-quimica-del-petroleo-productos-derivados-contaminacion-y-normativa.js">63 - Química del petróleo. Derivados, usos y contaminación. Normativa</option>
                    <option value="64-funciones-oxigenadas-y-nitrogenadas-caracteristicas-obtencion-y-propiedades-industriales.js">64 - Funciones oxigenadas y nitrogenadas: características, obtención y propiedades</option>
                    <option value="65-compuestos-aromaticos-el-benceno-y-otros-compuestos-de-interes-industrial.js">65 - Compuestos aromáticos. Benceno y derivados de interés industrial</option>
                    <option value="66-compuestos-organicos-de-importancia-biologica-alimentos-y-salud.js">66 - Compuestos orgánicos de importancia biológica. Alimentos y salud</option>
                    <option value="67-polimeros-naturales-y-sinteticos-obtencion-utilizacion-y-reciclado.js">67 - Polímeros naturales y sintéticos. Obtención, usos y reciclado</option>
                    <option value="68-rocas-y-minerales-del-relieve-espanol-propiedades-e-importancia-economica.js">68 - Rocas y minerales del relieve español. Propiedades e importancia económica</option>
                    <option value="69-origen-estructura-y-composicion-de-la-tierra-teorias-orogenicas-y-tectonica-de-placas.js">69 - Origen, estructura y composición de la Tierra. Orogénesis y tectónica de placas</option>
                    <option value="70-la-tierra-en-continuo-cambio-fosiles-y-tiempo-geologico-evolucion-y-mecanismos.js">70 - La Tierra en cambio continuo. Fósiles, tiempo geológico y evolución</option>
                    <option value="71-origen-de-la-vida-teoria-celular-y-base-quimica-de-la-vida-celula-y-herencia.js">71 - Origen de la vida. Teoría celular. Base química, célula y herencia</option>
                    <option value="72-seres-pluricelulares-nutricion-reproduccion-y-diversidad-de-los-seres-vivos.js">72 - Seres pluricelulares. Nutrición, reproducción y diversidad</option>
                    <option value="73-ecologia-poblaciones-comunidades-y-ecosistemas-problemas-ambientales-y-educacion.js">73 - Ecología. Poblaciones, comunidades y ecosistemas. Problemas ambientales</option>
                    <option value="74-salud-y-enfermedad-nutricion-reproduccion-y-salud-mental-estilos-de-vida-saludables.js">74 - Salud y enfermedad. Nutrición, reproducción y salud mental. Estilos de vida</option>
                    <option value="75-trabajo-experimental-en-ciencias-utilizacion-del-laboratorio-y-normas-de-seguridad.js">75 - Trabajo experimental en ciencias. Laboratorio escolar y normas de seguridad</option>
                </select>
            </div>
            <div class="grupo">
                <label for="cantidad">Número de preguntas</label>
                <input id="cantidad" type="number" min="5" max="40" value="10" />
            </div>
        </div>
        <div class="col">
            <p style="color:var(--muted);margin-top:0">Selecciona "Comenzar" para hacer el test o "Modo estudio" para repasar todas las respuestas.</p>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button id="btn-comenzar" class="primario">Comenzar</button>
                <button id="btn-aprender" title="Muestra todas las preguntas del temario en modo estudio">Modo estudio</button>
            </div>
        </div>
    </div>

    <div class="enlace-contenedor">
        <a class="enlace-constante" href="https://vertice1971.github.io/thomasbooks/Oposiciones_Secundaria/Men%C3%BA.html" target="_blank" rel="noopener">
            Enlace al Menú inicial con acceso a todos los recursos online gratuitos
        </a>
    </div>
</section>

<section id="pantalla-juego" class="tarjeta oculto">
    <div class="estado">
        <div class="contador-puntos"><strong id="xIndex">1</strong>/<span id="xTotal">12</span> · Puntos: <strong id="xPuntos">0</strong></div>
        <div class="progreso" aria-hidden="true"><div id="barra" class="barra" style="width:0%"></div></div>
    </div>

    <div id="enunciado" class="pregunta"></div>
    <div id="opciones" class="opciones"></div>

    <div class="pie">
        <div>
            <button id="btn-anterior" class="fantasma">Anterior</button>
            <button id="btn-saltar">Saltar</button>
        </div>
        <div>
            <button id="btn-comprobar" class="primario">Comprobar</button>
            <button id="btn-siguiente" class="exito oculto">Siguiente</button>
            <button id="btn-terminar" class="peligro oculto">Terminar</button>
        </div>
    </div>
</section>

<section id="pantalla-final" class="tarjeta oculto">
    <p class="resultado" id="resumen"></p>
    <div class="fila" style="margin-top:12px">
        <button id="btn-repetir" class="primario">Repetir configuración</button>
        <button id="btn-inicio">Volver al inicio</button>
        <button id="btn-estudio">Repasar preguntas</button>
    </div>
</section>

<section id="pantalla-estudio" class="tarjeta oculto">
    <div id="lista-estudio"></div>
    <div class="pie"><button id="btn-salir-estudio">Salir</button></div>
</section>

</div>

<script>
/* Portada: oculta tras retardo y libera scroll */
(function(){
    const cover = document.getElementById('cover');
    const liberar = ()=> document.body.classList.remove('bloqueado');
    window.addEventListener('load', function(){
        const T = 3000; // ms
        setTimeout(function(){
            if(!cover){ liberar(); return; }
            cover.classList.add('oculta');
            cover.addEventListener('transitionend', function onEnd(){
                cover.removeEventListener('transitionend', onEnd);
                if (cover && cover.parentNode) cover.parentNode.removeChild(cover);
                liberar();
            });
        }, T);
    }, {once:true});
})();

/* ===== Utilidades ===== */
function barajar(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

/* ===== Sistema de sonido (WebAudio) ===== */
class SistemaSonido{
    constructor(){
        this.ctx = null;
        this.master = null;
        this.enabled = true;
        this.initialized = false;
        this.volume = 0.15;
        this._unlocked = false;
    }
    init(){
        if(this.initialized) return;
        try{
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.master = this.ctx.createGain();
            this.master.gain.value = this.volume;
            this.master.connect(this.ctx.destination);
            this.initialized = true;
        }catch(e){}
    }
    ensure(){
        if(!this.initialized) this.init();
        if(this.ctx && this.ctx.state === "suspended") this.ctx.resume();
    }
    unlockOnce(){
        if(this._unlocked) return;
        this._unlocked = true;
        this.ensure();
    }
    tone(freq=440, dur=0.18, type="square"){
        if(!this.enabled) return;
        this.ensure();
        if(!this.ctx) return;
        const t0 = this.ctx.currentTime + 0.01;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = type;
        o.frequency.setValueAtTime(freq, t0);
        o.connect(g); g.connect(this.master);
        g.gain.setValueAtTime(1, t0);
        g.gain.exponentialRampToValueAtTime(0.0008, t0 + dur);
        o.start(t0);
        o.stop(t0 + dur);
    }
    reproducirAcierto(){
        this.tone(880, 0.16, "square");
        setTimeout(()=>this.tone(1245, 0.18, "square"), 120);
    }
    reproducirError(){
        this.tone(220, 0.22, "triangle");
    }
    mute(on){ this.enabled = !on; }
}
const sonido = new SistemaSonido();

["pointerdown","keydown"].forEach(ev=>{
    window.addEventListener(ev, ()=>sonido.unlockOnce(), { once:false, passive:true });
});
document.addEventListener("visibilitychange", ()=>{
    if(document.visibilityState==="visible") sonido.ensure();
});

/* ===== Carga de temarios ===== */
let BANCO = [];

function cargarTemario(nombreArchivo){
    return new Promise((resolve, reject)=>{
        delete window.PREGUNTAS;
        const prev = document.getElementById("temario-script");
        if(prev) prev.remove();

        const s = document.createElement("script");
        s.id = "temario-script";
        s.async = true;
        s.src = `temarios/${nombreArchivo}?t=${Date.now()}`;
        s.onload = ()=>{
            if(typeof window.PREGUNTAS === "undefined" || !Array.isArray(window.PREGUNTAS)){
                reject(new Error("El temario no define PREGUNTAS válidas."));
                return;
            }
            BANCO = convertirPreguntas(window.PREGUNTAS);
            resolve(BANCO);
        };
        s.onerror = ()=>reject(new Error("No se pudo cargar el temario."));
        document.body.appendChild(s);
    });
}

function convertirPreguntas(arr){
    return arr.map(p=>{
        const opciones = [p.correcta, ...(p.incorrectas||[])];
        const idxs = opciones.map((_,i)=>i);
        barajar(idxs);
        const opsBarajadas = idxs.map(i=>opciones[i]);
        const indiceCorrecta = idxs.indexOf(0);
        return {
            pregunta: p.enunciado,
            opciones: opsBarajadas,
            correcta: indiceCorrecta,
            explicacion: ""
        };
    });
}

/* ===== Estado/UI ===== */
const ui = {
    inicio:      document.getElementById("pantalla-inicio"),
    juego:       document.getElementById("pantalla-juego"),
    final:       document.getElementById("pantalla-final"),
    estudio:     document.getElementById("pantalla-estudio"),
    tema:        document.getElementById("tema"),
    cantidad:    document.getElementById("cantidad"),
    enunciado:   document.getElementById("enunciado"),
    opciones:    document.getElementById("opciones"),
    idx:         document.getElementById("xIndex"),
    total:       document.getElementById("xTotal"),
    puntos:      document.getElementById("xPuntos"),
    barra:       document.getElementById("barra"),
    resumen:     document.getElementById("resumen"),
    listaEstudio:document.getElementById("lista-estudio"),
    cabecera:    document.getElementById("cabecera-estado"),
    btns:{
        comenzar: document.getElementById("btn-comenzar"),
        aprender: document.getElementById("btn-aprender"),
        anterior: document.getElementById("btn-anterior"),
        saltar:   document.getElementById("btn-saltar"),
        comprobar:document.getElementById("btn-comprobar"),
        siguiente:document.getElementById("btn-siguiente"),
        terminar: document.getElementById("btn-terminar"),
        repetir:  document.getElementById("btn-repetir"),
        inicio:   document.getElementById("btn-inicio"),
        estudio:  document.getElementById("btn-estudio"),
        salirEst: document.getElementById("btn-salir-estudio")
    }
};

let estado = {
    preguntas: [], orden: [], actual: 0, puntos: 0, seleccion: null
};

/* ===== Cabecera dinámica ===== */
const CABECERA_INICIAL = ui.cabecera.textContent;
function setCabeceraTituloFromSelect(){
    const opt = ui.tema.options[ui.tema.selectedIndex];
    if(opt) ui.cabecera.textContent = opt.textContent;
}
function resetCabecera(){ ui.cabecera.textContent = CABECERA_INICIAL; }

/* ===== Navegación ===== */
function mostrar(section){
    for(const s of [ui.inicio, ui.juego, ui.final, ui.estudio]) s.classList.add("oculto");
    section.classList.remove("oculto");
    section.classList.add("aparece");
}

/* ===== Preparación desde BANCO ===== */
function prepararJuego(opts){
    const conjunto = barajar([...BANCO]);
    const n = Math.max(5, Math.min(opts.cantidad, conjunto.length));
    const seleccion = conjunto.slice(0, n).map(clonarYBarajarOpciones);

    estado.preguntas = seleccion;
    estado.orden = [...Array(estado.preguntas.length).keys()];
    estado.actual = 0; estado.puntos = 0; estado.seleccion = null;

    ui.total.textContent = String(estado.preguntas.length);
    ui.puntos.textContent = "0";
    ui.barra.style.width = "0%";

    setCabeceraTituloFromSelect();
    pintarPregunta();
    mostrar(ui.juego);
}

function clonarYBarajarOpciones(qo){
    const copia = JSON.parse(JSON.stringify(qo));
    const idxs = copia.opciones.map((_,i)=>i);
    barajar(idxs);
    const ops = idxs.map(i=>copia.opciones[i]);
    const corr = idxs.indexOf(copia.correcta);
    copia.opciones = ops; copia.correcta = corr;
    return copia;
}

/* ===== Pintado ===== */
function pintarPregunta(){
    const i = estado.actual;
    const q = estado.preguntas[i];
    ui.idx.textContent = String(i+1);

    // IMPORTANTE: usar innerHTML para renderizar fórmulas/entidades
    ui.enunciado.innerHTML = q.pregunta;

    ui.opciones.innerHTML = "";
    ui.btns.siguiente.classList.add("oculto"); ui.btns.terminar.classList.add("oculto");
    ui.btns.comprobar.classList.remove("oculto");

    const letras = "ABCD".split("");
    q.opciones.forEach((texto, idx)=>{
        const btn = document.createElement("button");
        btn.className = "opcion";
        btn.setAttribute("data-idx", idx);
        // Las opciones ya usan innerHTML para permitir sub/sup/griegas
        btn.innerHTML = `<span class="letra">${letras[idx]||"?"}</span><span>${texto}</span>`;
        btn.addEventListener("click", ()=>{
            sonido.unlockOnce();
            seleccionar(idx);
        });
        ui.opciones.appendChild(btn);
    });

    actualizarProgreso(); estado.seleccion = null;
}

function seleccionar(idx){
    if(ui.btns.comprobar.classList.contains("oculto")) return;
    estado.seleccion = idx;
    [...ui.opciones.children].forEach(el=>el.style.outline="none");
    const el = ui.opciones.querySelector(`[data-idx="${idx}"]`);
    el.style.outline = `2px solid var(--focus)`;
    el.scrollIntoView({block:"nearest", behavior:"smooth"});
}

function actualizarProgreso(){
    const pct = (estado.actual/estado.preguntas.length)*100;
    ui.barra.style.width = `${pct}%`;
}

/* ===== Comprobación/flujo ===== */
function comprobar(){
    const q = estado.preguntas[estado.actual];
    const sel = estado.seleccion;
    const acierto = sel === q.correcta;

    [...ui.opciones.children].forEach((btn, idx)=>{
        if(idx===q.correcta) btn.classList.add("correcta");
        if(sel!==null && idx===sel && sel!==q.correcta) btn.classList.add("incorrecta");
        btn.style.cursor="default";
    });

    if(sel !== null){
        if(acierto){
            estado.puntos++;
            ui.puntos.textContent = String(estado.puntos);
            sonido.reproducirAcierto();
        }else{
            sonido.reproducirError();
        }
    }

    ui.btns.comprobar.classList.add("oculto");
    const ultima = estado.actual === estado.preguntas.length - 1;
    if(ultima){ ui.btns.terminar.classList.remove("oculto"); }
    else{ ui.btns.siguiente.classList.remove("oculto"); }
}

function siguiente(){ estado.actual++; pintarPregunta(); }
function anterior(){ if(estado.actual===0) return; estado.actual--; pintarPregunta(); }
function saltar(){ estado.seleccion = null; comprobar(); }

/* ===== Final ===== */
function terminar(){
    mostrar(ui.final);
    const n = estado.preguntas.length, p = estado.puntos, r = p/n;
    const med = r>=0.85 ? "Oro" : r>=0.65 ? "Plata" : r>=0.45 ? "Bronce" : "Finalista";
    ui.resumen.innerHTML = `Resultado: <span class="medalla">${med}</span>. Aciertos ${p}/${n}.`;
}

/* ===== Estudio ===== */
function entrarEstudio(pregs = BANCO){
    ui.listaEstudio.innerHTML = "";
    const frag = document.createDocumentFragment();
    const letras = "ABCD".split("");
    pregs.forEach((q,i)=>{
        const card = document.createElement("div");
        card.className = "tarjeta"; card.style.marginBottom = "12px";
        const h = document.createElement("div"); h.className = "pregunta";
        // IMPORTANTE: innerHTML también en modo estudio
        h.innerHTML = `${i+1}. ${q.pregunta}`;
        const lista = document.createElement("div"); lista.className = "opciones";
        q.opciones.forEach((op,idx)=>{
            const p = document.createElement("div");
            p.className = "opcion " + (idx===q.correcta?"correcta":"");
            p.innerHTML = `<span class="letra">${letras[idx]}</span><span>${op}</span>`;
            lista.appendChild(p);
        });
        const ex = document.createElement("div"); ex.className = "explicacion"; ex.textContent = q.explicacion || "";
        card.append(h, lista, ex); frag.appendChild(card);
    });
    ui.listaEstudio.appendChild(frag);
    mostrar(ui.estudio);
}

/* ===== Eventos ===== */
async function iniciarDesdeTemario(archivo, opts){
    await cargarTemario(archivo);
    prepararJuego(opts);
}

ui.btns.comenzar.addEventListener("click", async ()=>{
    sonido.unlockOnce();
    await iniciarDesdeTemario(ui.tema.value, { cantidad: Number(ui.cantidad.value || 12) });
});

ui.btns.aprender.addEventListener("click", async ()=>{
    sonido.unlockOnce();
    await cargarTemario(ui.tema.value);
    setCabeceraTituloFromSelect();
    entrarEstudio(barajar([...BANCO]));
});

ui.btns.comprobar.addEventListener("click", comprobar);
ui.btns.siguiente.addEventListener("click", siguiente);
ui.btns.anterior.addEventListener("click", anterior);
ui.btns.saltar.addEventListener("click", saltar);
ui.btns.terminar.addEventListener("click", terminar);

ui.btns.repetir.addEventListener("click", async ()=>{
    sonido.unlockOnce();
    await iniciarDesdeTemario(ui.tema.value, { cantidad: estado.preguntas.length });
});

ui.btns.inicio.addEventListener("click", ()=>{ resetCabecera(); mostrar(ui.inicio); });
ui.btns.estudio.addEventListener("click", ()=>entrarEstudio(estado.preguntas));
ui.btns.salirEst.addEventListener("click", ()=>mostrar(ui.final));

document.addEventListener("keydown", (e)=>{
    if(ui.juego.classList.contains("oculto")) return;
    if(e.key==="Enter") {
        if(!ui.btns.comprobar.classList.contains("oculto")) comprobar();
        else if(!ui.btns.siguiente.classList.contains("oculto")) siguiente();
    }
    if(e.key==="ArrowRight" && !ui.btns.siguiente.classList.contains("oculto")) siguiente();
    if(e.key==="ArrowLeft") anterior();
});

/* Inicio */
mostrar(ui.inicio);
</script>

</body>
</html>
