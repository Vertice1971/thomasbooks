<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trivia – Duel</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:Georgia,serif;background:linear-gradient(135deg,#2c1810 0%,#8b4513 50%,#deb887 100%);color:#f4e4bc;min-height:100vh;padding:20px}
  .container{max-width:980px;margin:0 auto;background:rgba(0,0,0,.8);border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
  h1{text-align:center;color:#d4af37;font-size:2.2rem;margin-bottom:6px;text-shadow:2px 2px 4px rgba(0,0,0,.7)}
  .email{text-align:center;margin-bottom:20px}
  .email a{color:#d4af37;text-decoration:none}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  .bar{display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap;margin:16px 0}
  .card{background:rgba(139,69,19,.25);border:1px solid #8b4513;border-radius:10px;padding:14px}
  .grow{flex:1}
  label{font-weight:bold;margin-right:8px}
  select,button{font-size:1rem;border-radius:8px;border:2px solid #d4af37;background:rgba(212,175,55,.08);color:#f4e4bc;padding:10px}
  button{cursor:pointer;font-weight:bold}
  button:hover{background:rgba(212,175,55,.25)}
  button:disabled{opacity:.6;cursor:not-allowed}
  .score{min-width:210px;text-align:center;border:2px solid #d4af37;background:rgba(212,175,55,.18)}
  .current{border-color:#ff6b35;background:rgba(255,107,53,.18)}
  .status{margin:12px 0;padding:12px;border-radius:8px;background:rgba(212,175,55,.12);text-align:center}
  .qbox{margin-top:12px}
  .badge{display:inline-block;padding:4px 10px;border-radius:20px;font-weight:bold;margin-bottom:8px}
  .easy{background:#28a745}
  .intermediate{background:#ffc107;color:#000}
  .hard{background:#dc3545}
  .question{font-size:1.15rem;line-height:1.5;margin:10px 0 14px}
  .answers{display:grid;gap:10px}
  .ans{background:rgba(212,175,55,.1);border:2px solid #d4af37;color:#f4e4bc;padding:12px;border-radius:8px;text-align:left;cursor:pointer}
  .ans:hover{background:rgba(212,175,55,.25)}
  .right{background:rgba(40,167,69,.28);border-color:#28a745}
  .wrong{background:rgba(220,53,69,.28);border-color:#dc3545}
  .setup-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000}
  .setup-content{background:rgba(0,0,0,.9);border:2px solid #d4af37;border-radius:14px;padding:24px;max-width:400px;width:90%;text-align:center}
  .setup-content h2{color:#d4af37;margin-bottom:20px}
  .setup-content input{width:100%;margin:10px 0;padding:10px;border:2px solid #d4af37;background:rgba(212,175,55,.08);color:#f4e4bc;border-radius:8px;font-size:1rem}
  .setup-content button{margin:10px 5px}
</style>
</head>
<body>
<!-- Modal de configuración inicial -->
<div class="setup-modal" id="setupModal">
  <div class="setup-content">
    <h2>Configuración de Jugadores</h2>
    <label for="player1Name">Nombre del Jugador 1:</label>
    <input type="text" id="player1Name" placeholder="Jugador 1" maxlength="20">
    <label for="player2Name">Nombre del Jugador 2:</label>
    <input type="text" id="player2Name" placeholder="Jugador 2" maxlength="20">
    <br>
    <button id="startGameBtn">Comenzar Juego</button>
  </div>
</div>

<div class="container">
  <h1>TRIVIA – DUEL</h1>
  <div class="email"><a href="mailto:tomcue@iesjuandelacierva.com">tomcue@iesjuandelacierva.com</a></div>

  <div class="bar">
    <div class="card grow">
      <div class="row">
        <label for="topicSelect">Tema</label>
        <span id="topicName" class="badge" style="display:none;"></span>
        <select id="topicSelect"></select>
        <button id="loadTopicBtn">Cargar tema</button>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="newQBtn" disabled>Nueva pregunta</button>
        <button id="resetBtn">Reiniciar</button>
      </div>
    </div>
    <div class="card score" id="p1">
      <div id="p1name">Jugador 1</div>
      <div>Puntos: <span id="p1pts">0</span></div>
    </div>
    <div class="card score" id="p2">
      <div id="p2name">Jugador 2</div>
      <div>Puntos: <span id="p2pts">0</span></div>
    </div>
  </div>

  <div class="status" id="status">Configura los nombres de los jugadores para comenzar.</div>

  <div class="card qbox" id="qCard" style="display:none">
    <div class="badge" id="badge"></div>
    <div class="question" id="qText"></div>
    <div class="answers" id="answers"></div>
  </div>
</div>

<script>
/* ========= Configuración de puntuación =========
   Turno propio:
     Fácil: +1.0
     Intermedia: +1.5
     Difícil: +2.0
   Rebotes:
     Sobre Intermedia o Difícil: +0.5 por acierto (cada una).
     Rebote de Fácil (tras fallo del rival en Fácil): el rival gana +1.0 si acierta esa misma Fácil.
*/
const SCORE_OWN = { easy: 1.0, intermediate: 1.5, hard: 2.0 };
const SCORE_REBOUND_INTERM = 0.5;
const SCORE_REBOUND_HARD = 0.5;

const TOPICS_FILE = 'topics.js'; // define window.TRIVIA_TOPICS = [{id,title}] y opcional TRIVIA_TOPIC_PATHS
const PATH = (id, diff) => `temarios/${id}_${diff}.js`;

/* ========= Sonidos ========= */
let audioContext;

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
}

function playSound(frequency, duration, type = 'sine') {
  if (!audioContext) return;

  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);

  oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
  oscillator.type = type;

  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + duration);
}

function playCorrectSound() {
  playSound(523, 0.15);
  setTimeout(() => playSound(659, 0.15), 100);
}

function playWrongSound() {
  playSound(392, 0.2);
  setTimeout(() => playSound(294, 0.3), 150);
}

/* ========= Estado ========= */
const state = {
  currentTopicId: null,
  loadedDiffs: new Set(),
  store: { easy: [], intermediate: [], hard: [] },
  used:  { easy: new Set(), intermediate: new Set(), hard: new Set() },

  turn: 1,
  score: { 1: 0, 2: 0 },
  phase: 'idle',
  lock: false,

  playerNames: { 1: 'Jugador 1', 2: 'Jugador 2' },

  current: { diff: null, idx: null, perm: null },

  originalTurnPlayer: null,
  pendingReturnToOriginal: false,
  fullTurnMode: false,
  fullTurnStartAt: 'easy',

  turnCount: 0,
  turnLimit: 10
};

/* ========= Utilidades ========= */
function $(id){ return document.getElementById(id); }
function setStatus(msg){ $('status').textContent = msg; }
function markTurn(){
  $('p1').classList.toggle('current', state.turn === 1);
  $('p2').classList.toggle('current', state.turn === 2);
}
function toFixed1(n){ return (Math.round(n*10)/10).toFixed(1).replace(/\.0$/,''); }

function loadScript(src){
  return new Promise((resolve, reject)=>{
    const s = document.createElement('script');
    s.src = src; s.async = true;
    s.onload = ()=>resolve(src);
    s.onerror = ()=>reject(new Error('Error al cargar '+src));
    document.head.appendChild(s);
  });
}

/* ========= API para archivos externos =========
   Cada archivo de dificultad debe llamar:
   addQuestions('<easy|intermediate|hard>', [ { q, a:[...], correct:0 }, ... ])
*/
window.addQuestions = function(diff, arr){
  if(!state.store[diff]) state.store[diff] = [];
  for(const q of arr){
    if(!q || typeof q.q!=='string' || !Array.isArray(q.a) || typeof q.correct!=='number') continue;
    state.store[diff].push(q);
  }
};

/* ========= Carga de temas y preguntas ========= */
async function loadTopics(){
  try {
    await loadScript(TOPICS_FILE);
    const list = Array.isArray(window.TRIVIA_TOPICS) ? window.TRIVIA_TOPICS : [];
    const sel = $('topicSelect');
    sel.innerHTML = '';
    for(const t of list){
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.textContent = t.title || t.id;
      sel.appendChild(opt);
    }
    setStatus('Selecciona un tema y pulsa Cargar tema.');
  } catch(e) {
    setStatus('No se pudo cargar topics.js. Colócalo junto a este HTML.');
  }
}

async function loadTopicDifficulties(topicId){
  state.currentTopicId = topicId;
  state.loadedDiffs.clear();
  state.store = { easy: [], intermediate: [], hard: [] };
  state.used  = { easy: new Set(), intermediate: new Set(), hard: new Set() };
  clearQuestionUI();

  const custom = (window.TRIVIA_TOPIC_PATHS && window.TRIVIA_TOPIC_PATHS[topicId]) || null;
  const paths = {
    easy: custom?.easy || PATH(topicId,'easy'),
    intermediate: custom?.intermediate || PATH(topicId,'intermediate'),
    hard: custom?.hard || PATH(topicId,'hard')
  };

  await Promise.all([
    loadScript(paths.easy).then(()=>state.loadedDiffs.add('easy')),
    loadScript(paths.intermediate).then(()=>state.loadedDiffs.add('intermediate')),
    loadScript(paths.hard).then(()=>state.loadedDiffs.add('hard'))
  ]);

  let input = prompt("¿Número de turnos totales? (por defecto 10)", "10");
  const parsed = parseInt(input, 10);
  state.turnLimit = Number.isFinite(parsed) && parsed > 0 ? parsed : 10;
  state.turnCount = 0;

  $('newQBtn').disabled = false;
  setStatus(`Tema cargado. Pulsa Nueva pregunta para iniciar turno de ${state.playerNames[1]}. Turno 1/${state.turnLimit}.`);

  const topicTitle =
    (Array.isArray(window.TRIVIA_TOPICS)
      ? (window.TRIVIA_TOPICS.find(t => t.id === topicId)?.title)
      : null)
    || $('topicSelect')?.selectedOptions?.[0]?.textContent
    || topicId;

  $('topicName').textContent = topicTitle;
  $('topicName').style.display = 'inline-block';

  $('loadTopicBtn').style.display = 'none';
  $('topicSelect').style.display = 'none';
}

/* ========= Gestión de UI de preguntas ========= */
function clearQuestionUI(){
  $('qCard').style.display = 'none';
  $('answers').innerHTML = '';
  $('qText').textContent = '';
  $('badge').textContent = '';
  $('badge').className = 'badge';
}

function renderQuestion(diff, q, reusePerm=false){
  $('qCard').style.display = 'block';
  $('badge').className = 'badge ' + diff;
  $('badge').textContent = diff === 'easy' ? 'Fácil' : diff === 'intermediate' ? 'Intermedio' : 'Difícil';
  $('qText').textContent = q.q;

  let perm = state.current.perm;
  if(!reusePerm || !Array.isArray(perm) || perm.length !== q.a.length){
    perm = [...q.a.keys()];
    for(let i = perm.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [perm[i], perm[j]] = [perm[j], perm[i]];
    }
    state.current.perm = perm;
  }

  const box = $('answers');
  box.innerHTML = '';
  perm.forEach((origIdx, displayIdx)=>{
    const btn = document.createElement('button');
    btn.className = 'ans';
    btn.textContent = q.a[origIdx];
    btn.onclick = ()=>onAnswer(displayIdx);
    box.appendChild(btn);
  });
}

function markResult(correctIdxDisplayed, chosenIdxDisplayed, revealCorrect){
  const btns = [...$('answers').children];
  btns.forEach((b,i)=>{
    if(revealCorrect && i===correctIdxDisplayed) b.classList.add('right');
    if(i===chosenIdxDisplayed && i!==correctIdxDisplayed) b.classList.add('wrong');
    b.disabled = true;
  });
}

/* ========= Selección de preguntas ========= */
function pickUnusedIndex(diff){
  const total = state.store[diff].length;
  if(total===0) return null;
  if(state.used[diff].size === total) return null;
  let idx;
  do { idx = Math.floor(Math.random()*total); } while(state.used[diff].has(idx));
  state.used[diff].add(idx);
  return idx;
}

function showNewQuestion(diff, keepSame=false){
  let idx = state.current.idx;
  if(!keepSame){
    idx = pickUnusedIndex(diff);
    if(idx===null){
      setStatus('No quedan preguntas sin usar en ' + diff + '.');
      return false;
    }
    state.current = { diff, idx, perm: null };
  }else{
    state.current = { diff, idx, perm: state.current.perm };
  }
  const q = state.store[diff][idx];
  renderQuestion(diff, q, keepSame);
  return true;
}

/* ========= Puntuación ========= */
function addPoints(player, points){
  state.score[player] = +(state.score[player] + points);
  $('p'+player+'pts').textContent = toFixed1(state.score[player]);
}

/* ========= Máquina de estados =========

Fases principales:
  idle
  own_easy, own_intermediate, own_hard
  opponent_attempt_easy
  rebound_intermediate
  rebound_hard
  full_easy / full_intermediate / full_hard
*/
function startNewTurn(){
  if(state.phase!=='idle') return;
  if(state.turnCount >= state.turnLimit){
    setStatus(`Fin de la partida. Se han jugado ${state.turnCount} turnos.`);
    $('newQBtn').disabled = true;
    return;
  }
  state.fullTurnMode = false;
  state.pendingReturnToOriginal = false;
  state.originalTurnPlayer = null;
  $('newQBtn').disabled = true;
  state.phase = 'own_easy';
  if(!showNewQuestion('easy')){
    state.phase = 'idle';
    $('newQBtn').disabled = false;
    return;
  }
  setStatus(`Turno de ${state.playerNames[state.turn]}. Pregunta Fácil. Turno ${state.turnCount+1}/${state.turnLimit}.`);
}

function onAnswer(chosenIdxDisplayed){
  if(state.lock) return;
  state.lock = true;

  const { diff, idx, perm } = state.current;
  const q = state.store[diff][idx];

  const correct = (perm[chosenIdxDisplayed] === q.correct);
  const displayedCorrectIdx = perm.indexOf(q.correct);

  if(correct) { playCorrectSound(); } else { playWrongSound(); }

  markResult(displayedCorrectIdx, chosenIdxDisplayed, correct);

  switch(state.phase){

    case 'own_easy':
      if(correct){
        addPoints(state.turn, SCORE_OWN.easy);
        state.phase = 'own_intermediate';
        setTimeout(()=> {
          if(showNewQuestion('intermediate')){
            setStatus(`${state.playerNames[state.turn]}, acertaste la Fácil (+${toFixed1(SCORE_OWN.easy)}). Ahora Intermedia. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          }else{
            endOwnTurn();
          }
          state.lock = false;
        }, 550);
      }else{
        state.originalTurnPlayer = state.turn;
        switchTurn();
        state.phase = 'opponent_attempt_easy';
        setTimeout(()=> {
          showNewQuestion('easy', true);
          setStatus(`Rebote: ${state.playerNames[state.turn]} intenta la misma Fácil. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          state.lock = false;
        }, 550);
      }
      return;

    case 'own_intermediate':
      if(correct){
        addPoints(state.turn, SCORE_OWN.intermediate);
        state.phase = 'own_hard';
        setTimeout(()=> {
          if(showNewQuestion('hard')){
            setStatus(`${state.playerNames[state.turn]}, acertaste la Intermedia (+${toFixed1(SCORE_OWN.intermediate)}). Ahora Difícil. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          }else{
            endOwnTurn();
          }
          state.lock = false;
        }, 550);
      }else{
        state.originalTurnPlayer = state.turn;
        switchTurn();
        state.phase = 'rebound_intermediate';
        setTimeout(()=> {
          showNewQuestion('intermediate', true);
          setStatus(`Rebote: ${state.playerNames[state.turn]} intenta la Intermedia por 0,5. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          state.lock = false;
        }, 550);
      }
      return;

    case 'own_hard':
      if(correct){
        addPoints(state.turn, SCORE_OWN.hard);
        setTimeout(()=> {
          setStatus(`${state.playerNames[state.turn]} acertó la Difícil (+${toFixed1(SCORE_OWN.hard)}). Fin de turno.`);
          endOwnTurn();
          state.lock = false;
        }, 550);
      }else{
        state.originalTurnPlayer = state.turn;
        switchTurn();
        state.phase = 'rebound_hard';
        setTimeout(()=> {
          showNewQuestion('hard', true);
          setStatus(`Rebote: ${state.playerNames[state.turn]} intenta la Difícil por 0,5. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          state.lock = false;
        }, 550);
      }
      return;

    case 'opponent_attempt_easy':
      if(correct){
        addPoints(state.turn, SCORE_OWN.easy);
        state.pendingReturnToOriginal = true;
        state.fullTurnMode = true;
        state.phase = 'full_intermediate';
        setTimeout(()=> {
          if(showNewQuestion('intermediate')){
            setStatus(`Correcto (+${toFixed1(SCORE_OWN.easy)}). Continúas tu turno en Intermedia. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          }else{
            completeFullTurnAndReturn();
          }
          state.lock = false;
        }, 550);
      }else{
        state.pendingReturnToOriginal = true;
        state.fullTurnMode = true;
        state.phase = 'full_easy';
        setTimeout(()=> {
          if(showNewQuestion('easy')){
            setStatus(`Fallaste el rebote. Comienzas tu turno desde Fácil. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          }else{
            completeFullTurnAndReturn();
          }
          state.lock = false;
        }, 550);
      }
      return;

    case 'rebound_intermediate':
      if(correct){
        addPoints(state.turn, SCORE_REBOUND_INTERM);
        state.phase = 'rebound_hard';
        setTimeout(()=> {
          if(showNewQuestion('hard')){
            setStatus(`Rebote Intermedia correcto (+${toFixed1(SCORE_REBOUND_INTERM)}). Puedes intentar la Difícil por 0,5. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          }else{
            startFullTurnAfterRebound();
          }
          state.lock = false;
        }, 550);
      }else{
        setTimeout(()=> {
          startFullTurnAfterRebound();
          state.lock = false;
        }, 550);
      }
      return;

    case 'rebound_hard':
      if(diff==='hard' && !state.fullTurnMode){
        if(correct){
          addPoints(state.turn, SCORE_REBOUND_HARD);
          setStatus(`Rebote Difícil correcto (+${toFixed1(SCORE_REBOUND_HARD)}).`);
        }else{
          setStatus(`Rebote Difícil fallado.`);
        }
        setTimeout(()=> {
          startFullTurnAfterRebound();
          state.lock = false;
        }, 550);
        return;
      }
      break;

    case 'full_easy':
      if(correct){
        addPoints(state.turn, SCORE_OWN.easy);
        state.phase = 'full_intermediate';
        setTimeout(()=> {
          if(showNewQuestion('intermediate')){
            setStatus(`Correcto (+${toFixed1(SCORE_OWN.easy)}). Ahora Intermedia. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          }else{
            completeFullTurnAndReturn();
          }
          state.lock = false;
        }, 550);
      }else{
        setTimeout(()=> {
          setStatus(`Fallo en Fácil. Fin de tu turno.`);
          completeFullTurnAndReturn();
          state.lock = false;
        }, 550);
      }
      return;

    case 'full_intermediate':
      if(correct){
        addPoints(state.turn, SCORE_OWN.intermediate);
        state.phase = 'full_hard';
        setTimeout(()=> {
          if(showNewQuestion('hard')){
            setStatus(`Correcto (+${toFixed1(SCORE_OWN.intermediate)}). Ahora Difícil. Turno ${state.turnCount+1}/${state.turnLimit}.`);
          }else{
            completeFullTurnAndReturn();
          }
          state.lock = false;
        }, 550);
      }else{
        setTimeout(()=> {
          setStatus(`Fallo en Intermedia. Fin de tu turno.`);
          completeFullTurnAndReturn();
          state.lock = false;
        }, 550);
      }
      return;

    case 'full_hard':
      if(correct){
        addPoints(state.turn, SCORE_OWN.hard);
        setTimeout(()=> {
          setStatus(`Correcto en Difícil (+${toFixed1(SCORE_OWN.hard)}). Fin de tu turno.`);
          completeFullTurnAndReturn();
          state.lock = false;
        }, 550);
      }else{
        setTimeout(()=> {
          setStatus(`Fallo en Difícil. Fin de tu turno.`);
          completeFullTurnAndReturn();
          state.lock = false;
        }, 550);
      }
      return;

    default:
      break;
  }

  state.lock = false;
}

/* ========= Transiciones de turno ========= */
function switchTurn(){
  state.turn = state.turn === 1 ? 2 : 1;
  markTurn();
}

function endOwnTurn(){
  clearQuestionUI();
  state.turnCount++;
  if(state.turnCount >= state.turnLimit){
    $('newQBtn').disabled = true;
    setStatus(`Fin de la partida. Se han jugado ${state.turnCount} turnos.`);
    state.phase = 'idle';
    return;
  }
  switchTurn();
  state.phase = 'idle';
  $('newQBtn').disabled = false;
  setStatus(`Turno de ${state.playerNames[state.turn]}. Pulsa Nueva pregunta. Turno ${state.turnCount+1}/${state.turnLimit}.`);
}

function startFullTurnAfterRebound(){
  state.pendingReturnToOriginal = true;
  state.fullTurnMode = true;
  state.phase = 'full_easy';
  if(showNewQuestion('easy')){
    setStatus(`Tu turno completo comienza en Fácil. Turno ${state.turnCount+1}/${state.turnLimit}.`);
  }else{
    completeFullTurnAndReturn();
  }
}

function completeFullTurnAndReturn(){
  clearQuestionUI();
  state.turnCount++;
  if(state.pendingReturnToOriginal && state.originalTurnPlayer){
    state.turn = state.originalTurnPlayer;
    markTurn();
    state.pendingReturnToOriginal = false;
    state.originalTurnPlayer = null;
  }else{
    switchTurn();
  }
  state.fullTurnMode = false;
  state.phase = 'idle';

  if(state.turnCount >= state.turnLimit){
    $('newQBtn').disabled = true;
    setStatus(`Fin de la partida. Se han jugado ${state.turnCount} turnos.`);
    return;
  }

  $('newQBtn').disabled = false;
  setStatus(`Turno de ${state.playerNames[state.turn]}. Pulsa Nueva pregunta. Turno ${state.turnCount+1}/${state.turnLimit}.`);
}

/* ========= Eventos ========= */
document.addEventListener('DOMContentLoaded', function() {
  markTurn();

  const startBtn = document.getElementById('startGameBtn');
  startBtn.addEventListener('click', function() {
    const name1 = document.getElementById('player1Name').value.trim() || 'Jugador 1';
    const name2 = document.getElementById('player2Name').value.trim() || 'Jugador 2';

    state.playerNames[1] = name1;
    state.playerNames[2] = name2;
    document.getElementById('p1name').textContent = name1;
    document.getElementById('p2name').textContent = name2;

    document.getElementById('setupModal').style.display = 'none';

    initAudio();

    loadTopics();
  });

  document.getElementById('player1Name').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      startBtn.click();
    }
  });

  document.getElementById('player2Name').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      startBtn.click();
    }
  });

  document.getElementById('loadTopicBtn').addEventListener('click', async function() {
    const id = document.getElementById('topicSelect').value;
    if(!id){
      setStatus('Selecciona un tema.');
      return;
    }
    try{
      await loadTopicDifficulties(id);
    }catch(e){
      setStatus('Error al cargar archivos de preguntas del tema seleccionado.');
    }
  });

  document.getElementById('newQBtn').addEventListener('click', startNewTurn);

  document.getElementById('resetBtn').addEventListener('click', function() {
    state.turn = 1;
    state.score = {1:0,2:0};
    document.getElementById('p1pts').textContent = '0';
    document.getElementById('p2pts').textContent = '0';
    state.phase = 'idle';
    state.lock = false;
    state.originalTurnPlayer = null;
    state.pendingReturnToOriginal = false;
    state.fullTurnMode = false;
    state.current = { diff:null, idx:null, perm:null };
    state.turnCount = 0;
    clearQuestionUI();
    markTurn();
    document.getElementById('newQBtn').disabled = !state.currentTopicId;

    document.getElementById('loadTopicBtn').style.display = 'inline-block';
    document.getElementById('topicSelect').style.display = 'inline-block';
    document.getElementById('topicName').textContent = '';
    document.getElementById('topicName').style.display = 'none';

    if(state.currentTopicId){
      setStatus(`Juego reiniciado. Pulsa Nueva pregunta. Turno 1/${state.turnLimit}.`);
    }else{
      setStatus('Juego reiniciado. Cargar topics.js y seleccionar un tema.');
    }
  });
});
</script>

</body>
</html>
